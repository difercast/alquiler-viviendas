---
title: "extracción de datos"
author: "Diego Castillo"
date: "13/11/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(ggplot2)
library(mice)
library(VIM)
library(FSelector)
library(hrbrthemes)
```

## Introducción

En el presente proyecto se realizará un análisis con el fin de encontrar las relaciones más importantes entre los atributos del mercado del alquiler de España y así resolver las preguntas de cuales son los patrones más importantes que tiene este mercado así como los sesgos del mismo. Para el desarrollo del proyecto de explotarán los datos de la Encuesta de Condiciones de Vida (INE, 2019), así como la información disponible del portal inmobiliario Idealista.

La Encuesta de Condiciones de Vida (ECV) es una operación estadística que se lleva a cabo de manera anual por el INE, cuyo objetivo es la producción sitemática de estadísticas comunitarias sobre la renta y las condiciones de vida de la población. Incluye datos transversales y longitudinales comparables y actualizados sobre la renta, el nivel y composición de la pobreza y la exclusión social, a escala nacional y europea. 

Entre los diferentes aspectos a los cuales la ECV está orientada, es de especial relevancia para el presente proyecto los referentes a los ingresos y situación económica de los hogares, empleo, vivienda, movimientos migratorios y nivel de formación.

El portal inmobiliario Idealista es uno de los principales sitios web de anuncios de alquiler y venta de inmuebles, funciona en varios países europero y tiene vasta presencia en España desde hace ya varios años. Idealista pone a disposición una API pública mediante la cual se puede realizar la consulta de la información del alquiler y venta según el lugar deseado.

En primer lugar, se realiza la extracción, tratamiento y exploración de los datos de la ECV.


## Extracción de la información

Se realiza la extracción de la información correspondiente a la Encuesta de Condiciones de Vida (ECV) obtenida desde la web oficial del INE para el periodo 2019. El INE pone a disposición del público en general los datos de la ECV, los cuales están conformados por 4 ficheros en formato csv los cuales contienen información básica y detallada de los hogares y personas encuestadas. En el presente proyecto se realizará el análisis de los datos detallados de hogares y personas.


```{r data_extract}
hogares <- read.csv('../data/data_collect/enc_condiciones_vida/esudb19h.csv', header= TRUE, sep= ',', stringsAsFactors= FALSE )
personas <- read.csv('../data/data_collect/enc_condiciones_vida/esudb19p.csv', header= TRUE, sep= ',', stringsAsFactors= FALSE )
```

## Data cleaning

### Conjunto de datos de *Hogares*

El proceso de limpieza de la información consta de la eliminación de atributos que no son relevantes para el análisis que se realizará, más bien son atributos que cuentan con información descriptiva de la encuesta en si. Las variables a eliminar se listan a continuación:

| Variable | Descripción |
| ----------- | ----------- |
| HB010 | Año de la encuesta |
| HB020 | País |
| HB050 | Mes de la entrevista |
| HB050_F | Mes de la entrevista - Flag |
| HB060 | Año de la entrevista |
| HB060_F | Año de la entrevista - Flag |
| HB070 | Identificación personal del informante del cuestionario sobre el hogar |
| HB070_F | Identificación personal del informante del cuestionario sobre el hogar - Flag |
| HB080 | Identificación de la primera persona responsable de la vivienda |
| HB080_F | Identificación de la primera persona responsable de la vivienda - Flag |
| HB090 | Identificación de la segunda persona responsable de la vivienda |
| HB090_F | Identificación de la segunda persona responsable de la vivienda - Flag |
| HB100 | Numero de minutos empleados en cumplimentar el cuestionario sobre el hogar |
| HB100_F | Numero de minutos empleados en cumplimentar el cuestionario sobre el hogar - Flag |


```{r drop_columns_hog}
# Se genera un vector con las variables se eliminarán del data frame
col_borrar_hogares <- c('HB010','HB020','HB050','HB050_F','HB060','HB060_F','HB070','HB070_F','HB080','HB080_F','HB090','HB090_F','HB100','HB100_F')

# Se eliminan las variables innecesarias
hogares <-hogares %>% select(-one_of(col_borrar_hogares))
```




## Análisis exploratorio de datos

### Régimen de tenencia

La variable `HH021` de la ECV almacena el régimen de tenencia del hogar encuestado, por lo que primero se analiza como se distribuye la información dentro de esta variable.

```{r graficar_hh021}
# Se coloca los labels para ver el gráfico de manera correcta.
hogares$HH021 <- factor(hogares$HH021,levels = c(1,2,3,4,5),labels = c('En propiedad sin hipoteca','En propiedad con hipoteca','En alquiler o realquiler a precio de mercado','En alquiler o realquiler a precio inferior al de mercado','En cesión gratuita'))

# se realiza el gráfico
g1.hh021 <- ggplot(hogares, aes(HH021)) +
  geom_bar(fill="steelblue") +
  geom_text(aes(label=..count..), stat='count', vjust=1, color="black", size=3.5) +
  coord_flip()
g1.hh021
```


El régimen de tenencia predominante es el de la propiedad con un total de `12.456` hogares encuestados que corresponde al `78.4%` del total de la población de la encuesta. El motivo del presente análisis son aquellas viviendas que están en un régimen de alquiler, en donde se tiene que la tenencia de alquiler a precio de mercado se cuenta con un total de `2.163` registros que corresponde al `13,61%` y para el régimen de tenencia de alquiler a precio inferior al mercado se tienen `446` registros que equivale al `2,8%`. 

El objetivo del presente proyecto es realizar el análisis de los hogares y las personas que residen en esos hogares en un régimen de tenencia de alquiler. No se toma en cuenta para el análisis los registro que corresponden a los hogares con un régimen de tenencia de alquiler a precio inferior al mercado, ya que dichos precios pueden afectar el valor real del mercado del alquiler.

```{r}
hogares.alquiler <- filter(hogares, HH021 == 'En alquiler o realquiler a precio de mercado')
```

### Precio del alquiler

La variable con más relevancia del conjunto de datos, es aquella que contiene el valor que las familias pagan por el alquiler de una vivienda en la que residen. Dentro del conjunto de datos, esta variable se denota como `HH060`. Se analiza en primera instancia si dentro de los hogares con tenencia en alquiler se tienen valores nulos.

```{r}
sum(is.na(hogares.alquiler$HH060))
```

Existen `r sum(is.na(hogares.alquiler$HH060))` valores vacios o nulos para la variable HH060, se aplicará en este caso la imputación por ...

Se analiza la distribución del precio del alquiler de las viviendas utilizando un diagrama de cajas.

```{r}
ggplot(hogares.alquilados, aes(x = HH021, y = HH060, fill = HH021)) + geom_boxplot()
```

Se observa que La mediana del valor a pagar por el alquiler de una vivienda corresponde a `r median(hogares.alquilados$HH060[hogares.alquilados$HH021 == 'En alquiler o realquiler a precio de mercado'], na.rm = TRUE) `. Se puede observar que existen valores que superan el valor del tercer cuartil, por lo que se consideran como outliers, no se realizara la imputación de dichos valores ya que se entiende que existen ciertos casos en donde dependiendo de las características de las viviendas el valor del alquiler es muy elevado.

### Precio del alquiler vs rentas de la vivienda

```{r}
g1.hh060hy020 <- ggplot(data = hogares.alquiler) + 
  geom_point(aes(HH060, HY020))
g1.hh060hy020
```



### Precio del alquiler vs Nacionalidad

Se realiza la unión entre los conjuntos de datos de hogares y los conjuntos de datos de personas, para realizar el análisis de las características del mercado del alquiler.

```{r}
# Se genera la variable con el identificador de la vivienda
personas <- personas %>% mutate(HB030 = as.integer(substr(PB030,1,nchar(PB030)-2)))

personas <- left_join(personas, hogares.alquiler, by ='HB030', copy =FALSE)
personas.alquiler <- filter(personas, HH021 == 'En alquiler o realquiler a precio de mercado')

personas.alquiler$PB210 <- factor(personas.alquiler$PB210,levels =c(1,2,3), labels =c('España','Extranjero (resto de la unión europea)','Extranjero (resto del mundo)'))
```


```{r}
g1.nacionalidad <- ggplot(personas.alquiler, aes(x=carrier, y= dep_delay)) + 
        geom_boxplot()

g1.nacionalidad <- ggplot(data = subset(personas.alquiler, !is.na(PB210)), aes(PB210, HH060)) +
  geom_boxplot() 
g1.nacionalidad
```


### Precio del alquiler por el grupo de edad

```{r}
personas.alquiler <- personas.alquiler %>% mutate(edad = PB110 - PB140)
personas.alquiler <- personas.alquiler %>% mutate(grupos.edad = case_when(edad <30 ~ 'Menor de 30',
                                                                          edad >=30 ~ 'Mayor o igual a 30'))
```


Gráfico

```{r}

g1.gruposEdad <- ggplot(data = subset(personas.alquiler, !is.na(grupos.edad)), aes(grupos.edad, HH060)) +
  geom_boxplot() 
g1.gruposEdad
```

